---
title: "Trend Assessment - Environmental/Lower Trophic Levels"
output:
  html_document:
    df_print: paged
---

```{r message = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.align='center')

#Required libraries
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(here)
library(zoo)
library(kableExtra)
library(sf)
library(rgdal)
library(raster)
library(sp)
library(gridExtra)
library(corrplot)
library(tseries)

#Data directories
raw.dir <- here("inst","extdata") #raw data directory
clean.dir <- here("data") #output directory for cleaned data
gis.dir <- here("inst","extdata","gis")
sample.dir <- here("inst","extdata","sample")

#CRS
crs <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#Normalize
get_dat <- function(field){
  time <- env[env$Var == field,]$Time
  end = max(time)
  time = time[1:which(time == end)]
  Value <- env[env$Var == field,]$Value
  
  if (all(is.na(as.numeric(Value))) | sd(Value, na.rm = T) == 0){
    Value <- NA
  } else {
    
    Value <- Value[1:length(time)]
    Value <- (Value-mean(Value, na.rm = TRUE))/sd(Value, na.rm = TRUE)
    
    #interpolate missing values
    if (any(is.na(Value))){
      Value <- approx(time, Value, n = length(Value))$y
    }
    
    #fit 1st order differencing model  
    mod <- arima(Value, order = c(0,1,0))
    Value <- resid(mod)
  
    #test for stationarity with Augmented Dickey Fuller
    adf <- suppressWarnings(adf.test(Value)$p.value)
  
    if (adf > 0.05){
      warning("Series non-stationary")
    }
  
  }
  
  out <- data.frame(var = field,
                    value = as.numeric(Value),
                    time = time)
  return(out)
}

```


```{r data_load}
lapply(file.path(clean.dir,as.list(list.files(clean.dir))),load,environment())

#aggregate to year
nutrients <- NE_LME_nutrients %>% 
  group_by(EPU, Time = year(Time), Var) %>% 
  dplyr::summarise(Value = mean(Value, na.rm = TRUE)) %>% 
  as.data.frame()
rm(NE_LME_nutrients)
ocean_sal <- ocean_sal_insitu %>%
 group_by(Time = year(Time), EPU, Var) %>%
 dplyr::summarise(Value = mean(Value)) %>% 
  as.data.frame()

ocean_temp <- ocean_temp_insitu %>%
 group_by(Time = year(Time), EPU, Var) %>%
 dplyr::summarise(Value = mean(Value)) %>% 
  as.data.frame()

wind <- wind_clean %>%
  mutate(Time = year(Time)) %>% #find year
  group_by(Time, EPU, Var) %>% #group by season
  dplyr::summarise(Value = mean(Value)) %>% 
  as.data.frame()

strat <- stratification %>%
  dplyr::select(-Units) %>% 
  mutate(Time = year(Time)) %>% 
  as.data.frame()

#Bind all
env <- rbind(nutrients,
              ocean_sal,
              ocean_temp,
              strat,
              wind)
env$Var <- paste(env$Var, env$EPU) #create unique Var column
fields <- as.list(unique(env$Var)) #get fields for normalization


```

```{r plot_unique, message = FALSE, warning = FALSE}
#Normalize
norm_env <- lapply(fields, get_dat)
norm_env <- do.call(rbind,norm_env)
norm_env <- norm_env %>% dplyr::rename(Time = time, Var = var, Value = value)

# ggplot(data = norm_env) +
#   geom_line(aes(x = Time, y = Value, color = Var)) +
#   guides(color = FALSE) +
#   ylab("Normalized Value")+
#   theme_bw()+
#   ggtitle("Normalized ENV/LTL Time Series")
```

```{r MAB_corr, fig.width = 10, fig.height = 10}
env_wide <- norm_env %>%
  group_by(Var) %>% 
  mutate(count = n()) %>% 
  filter(count > 20, !str_detect(Var,"reference"), str_detect(Var,"MAB")) %>% 
  dplyr::select(-count) %>%
  spread(., Var, Value) 

names(env_wide) <- str_replace(names(env_wide), "MAB", "")

env_wide <- env_wide[complete.cases(env_wide),]

env_cor <- cor(env_wide)
corrplot(env_cor, diag = FALSE, order = "FPC",
         tl.pos = "td", tl.cex = 0.5, method = "color", type = "upper")

t <- prcomp(env_wide)
# heatmaply_cor(env_cor, margins = c(40, 40),
#           k_col = 2, k_row = 2,
#           limits = c(-1,1))
```

