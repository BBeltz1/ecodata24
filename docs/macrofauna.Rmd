---
title: "Macrofauna"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    theme: lumen
---

```{r setup, include=FALSE}

#Default Rmd options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center') #allows for inserting R code into captions

#Plotting and data libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(ecodata)
library(here)
library(kableExtra)
library(ggrepel)
library(stringr)
library(patchwork)
library(grid)
library(ggiraph)
library(vegan)

#GIS libraries
library(sf)
library(rgdal)
library(raster)
library(rnaturalearth)


#GIS directory
gis.dir <- here::here("inst","extdata","gridded")

#General inline text input for report
#Council
council <- "Mid-Atlantic Fishery Management Council"
council_abbr <- "MAFMC"

#Region identifiers
epu <- "Mid-Atlantic Bight"
epu_abbr <- "MAB"
region <- "Mid-Atlantic"
region_abbr <- "MA" #Some commercial data organized by "MA" or "NE" regions, not by EPU 


```

```{r GIS-setup}

#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#Coastline shapefile
coast <- ne_countries(scale = 10,
                          continent = "North America",
                          returnclass = "sf") %>%
             sf::st_transform(crs = crs)

#State polygons
ne_states <- ne_states(country = "united states of america",
                                      returnclass = "sf") %>%
  sf::st_transform(crs = crs)

#high-res polygon of Maine
new_england <- read_sf(gis.dir,"new_england")

#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB","GB","GOM"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -77
xmax = -65
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2009
x.shade.max <- 2018
#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}
```

Trend lines are shown when slope is significantly different from 0 at the p < 0.05 level. An orange line signifies an overall positive trend, and purple signifies a negative trend. To minimize bias introduced by small sample size, no trend is fit when N < 30. Dashed lines represent mean values of time series unless the indicator is an anomaly, in which case the dashed line is equal to 0. Shaded regions indicate the past ten years. If there are no new data for 2018, the shaded region will still cover this time period.

## Mid-Atlantic Bight

### Surveys {.tabset .tabset-fade}

#### NEFSC BTS & NEAMAP 

```{r nefsc-biomass-mab, fig.cap = paste0("Fall (left) and spring (right) surveyed biomass in the Mid-Atlantic Bight. Data from the NEFSC Bottom Trawl Survey are shown in black, with NEAMAP shown in red. \\label{nefsc-biomass}"), fig.width=8, fig.asp = 0.75}
total_surv <- nefsc_survey %>% 
  filter(EPU == epu_abbr,
         !str_detect(Var, "Other|Apex|managed"),
         Time >= 1968) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value)) %>% 
  ungroup() %>% 
  mutate(Var = word(Var, 1,2))
series.col <- rep("black",length(unique(total_surv$Var)))
total_surv$Var <- factor(total_surv$Var,levels = c("Piscivore Fall",
                                                   "Piscivore Spring",
                                                    "Benthivore Fall",
                                                    "Benthivore Spring",
                                                    "Planktivore Fall",
                                                    "Planktivore Spring",
                                                    "Benthos Fall",
                                                    "Benthos Spring"))
#Create dataframe for label locations
label_loc <- total_surv %>%
  group_by(Var) %>%
  dplyr::summarise(yloc = max(Value)*0.95,
                   xloc = min(Time)) %>% 
  mutate(label = LETTERS[1:8])
#facet names for titles
facet_names <- list("Piscivores" = expression("Piscivores"),
                    "Planktivores" = expression("Planktivores"),
                    "Benthivores" = expression("Benthivores"),
                    "Benthos" = expression("Benthos"))

#Get NEAMAP
neamap <- ecodata::mab_inshore_survey %>% 
  mutate(season = str_to_title(word(Var),1),
         feeding.guild = str_to_title(word(Var,2))) %>% 
   filter(str_detect(Var, "index")) %>% 
 unite(.,Var,c("feeding.guild","season"), sep = " ") %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))

neamap$Var <- factor(neamap$Var,levels = c("Piscivore Fall",
                                                   "Piscivore Spring",
                                                    "Benthivore Fall",
                                                    "Benthivore Spring",
                                                    "Planktivore Fall",
                                                    "Planktivore Spring",
                                                    "Benthos Fall",
                                                    "Benthos Spring"))

ggplot(data = total_surv, aes(x = Time, y = Value, color = Var)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  geom_gls(aes(x = Time, y = Value,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  
  #Add NEAMAP
  geom_line(data = neamap, aes(x = Time, y = Value, color = Var),
            size = lwd-0.5,
            color = "#ca0020")+
  geom_point(data = neamap, aes(x = Time, y = Value, color = Var),
             size = pcex-0.5,
             color = "#ca0020")+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Biomass (kg tow"^-1*")")) +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))
```

#### Proportion managed species in NEFSC BTS

```{r mab-prop, fig.width = 8, fig.asp=0.9}
prop <- ecodata::nefsc_survey %>% 
  filter(Units == "proportion",
         !str_detect(Var, "Other|other")) %>% 
  mutate(council = ifelse(str_detect(Var, "NEFMC"),
                          "NEMFC", ifelse(str_detect(Var, "MAFMC"),
                                          "MAFMC", ifelse (str_detect(Var, "Non"),
                                                           "Non","Joint"))),
         feeding.guild = word(Var,1),
         season = ifelse(str_detect(Var,"Spring"),
                         "Spring",
                         "Fall")) %>% 
  unite(.,Var,c("feeding.guild","season"), sep = " ") %>% 
  filter(!str_detect(Var,"Apex|Benthos")) %>%
  mutate(Var2 = paste(council,Var),
         tt = paste(council,round(Value,2))) %>% 

    group_by(EPU,Var2) %>% 
  mutate(hline = mean(Value,na.rm = T)) 


prop$Var <- factor(prop$Var,levels = c("Piscivore Fall",
                                                   "Piscivore Spring",
                                                   "Benthivore Fall",
                                                   "Benthivore Spring",
                                                   "Planktivore Fall",
                                                   "Planktivore Spring"))
                                       # "Benthos Fall",
                                       # "Benthos Spring"))
# series.col <- rep("black",length(unique(prop$Var)))

mab_prop <- 
  prop %>% 
    filter(EPU == "MAB") %>% 
  dplyr::rename(Council = council) %>% 
ggplot(aes(x = Time, y = Value, color = Council, group = Var2)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
           xmin = x.shade.min , xmax = x.shade.max ,
           ymin = -Inf, ymax = Inf) +
  
  #Add time series
  geom_line(size = 0.5) +
  geom_point_interactive(aes(tooltip = tt),size = 0.5) +
#  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var2,
                 color = Council),
             size = 0.5,
             alpha = hline.alpha,
             linetype = hline.lty)+
  
  #Facet 
  facet_wrap(Var~., ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Proportion of survey")) +
  ggtitle("MAB") +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))
mab_prop <- girafe(ggobj = mab_prop)
mab_prop <- girafe_options(mab_prop, opts_zoom(max = 5) )
mab_prop
```


### Condition factor

```{r mab-cf, fig.cap = "Condition factor for MAFMC managed species."}
image.dir <- here::here("docs")

knitr::include_graphics(file.path(image.dir, "MAFMC_Fish_Condition_2019.jpg"))

```

### Larval diversity

```{r mab-larval-div}
ma_larv_div <- ecodata::ichthyo_diversity %>%
  filter(EPU == "MAB",
         str_detect(Var, "Ich Shannon")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("Mid-Atlantic larval diversity") +
  ylab("Shannon Diversity") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

ma_spec_rich <- ecodata::ichthyo_diversity %>%
  filter(EPU == "MAB",
         str_detect(Var, "Species Caught")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("Mid-Atlantic larval species richness") +
  ylab("Species richness") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

 ma_larv_div + ma_spec_rich + plot_layout(ncol = 1)
```


## New England

### Surveys {.tabset .tabset-fade}

#### NEFSC BTS

```{r gom-biomass-ne, fig.cap = paste0("Fall (left) and spring (right) NEFSC surveyed biomass in the Gulf of Maine."), fig.width=8, fig.asp = 0.75}
total_surv <- nefsc_survey %>% 
  filter(EPU %in% c("GOM","GB"),
         !str_detect(Var, "Other|Apex|managed"),
         Time >= 1968) %>% 
  group_by(EPU,Var) %>% 
  mutate(hline = mean(Value)) %>% 
  ungroup() %>% 
  mutate(Var = word(Var, 1,2))
series.col <- rep("black",length(unique(total_surv$Var)))
total_surv$Var <- factor(total_surv$Var,levels = c("Piscivore Fall",
                                                   "Piscivore Spring",
                                                    "Benthivore Fall",
                                                    "Benthivore Spring",
                                                    "Planktivore Fall",
                                                    "Planktivore Spring",
                                                    "Benthos Fall",
                                                    "Benthos Spring"))



#facet names for titles
facet_names <- list("Piscivores" = expression("Piscivores"),
                    "Planktivores" = expression("Planktivores"),
                    "Benthivores" = expression("Benthivores"),
                    "Benthos" = expression("Benthos"))

gom_surv <- total_surv %>% 
  filter(EPU == "GOM") %>% 
ggplot(aes(x = Time, y = Value, color = Var)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  geom_gls(aes(x = Time, y = Value,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Biomass (kg tow"^-1*")")) +
  ggtitle("GOM NEFSC BTS") +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))

gom_surv
```

```{r gb-biomass-ne, fig.cap = paste0("Fall (left) and spring (right) NEFSC surveyed biomass in Georges Bank."), fig.width=8, fig.asp = 0.75}

gb_surv <- total_surv %>% 
  filter(EPU == "GB") %>% 
ggplot(aes(x = Time, y = Value, color = Var)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  geom_gls(aes(x = Time, y = Value,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Biomass (kg tow"^-1*")")) +
  ggtitle("GB NEFSC BTS") +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))

gb_surv

```

#### MA inshore survey

```{r MA-inshore, fig.width=8, fig.asp = 0.75, fig.cap = "Fall (left) and spring (right) surveyed biomass from the MA state inshore bottom trawl survey."}
mass <- mass_inshore_survey %>% 
  filter(str_detect(Var, "Index")) %>% 
  mutate(feeding.guild = str_extract(Var, paste(feeding.guilds, collapse = "|")),
         Season = str_extract(Var, "Spring|Fall")) %>%
  filter(!is.na(feeding.guild)) %>% 
  unite(.,Var, c("feeding.guild","Season"),sep = " ") %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))
mass$Var <- factor(mass$Var,levels = c("Piscivore Fall",
                                                   "Piscivore Spring",
                                                    "Benthivore Fall",
                                                    "Benthivore Spring",
                                                    "Planktivore Fall",
                                                    "Planktivore Spring",
                                                    "Benthos Fall",
                                                    "Benthos Spring"))

mass %>% 
  ggplot(aes(x = Time, y = Value, color = Var)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  geom_gls(aes(x = Time, y = Value,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Biomass (kg tow"^-1*")")) +
  ggtitle("MA Inshore BTS") +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))

```

#### ME/NH inshore survey

```{r menh-survey,fig.width=8, fig.asp = 0.75, fig.cap = "Fall (left) and spring (right) surveyed biomass from the ME/NH state inshore bottom trawl survey."}

menh <- ecodata::ne_inshore_survey %>% 
  filter(Units != "CV",
         !str_detect(Var, " se| ci")) %>% 
  mutate(feeding.guild = str_to_title(str_extract(Var, paste(tolower(feeding.guilds), collapse = "|"))),
         Season = str_to_title(str_extract(Var, "fall|spring"))) %>% 
    unite(.,Var, c("feeding.guild","Season"),sep = " ") %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))
  

menh$Var <- factor(menh$Var,levels = c("Piscivore Fall",
                                                   "Piscivore Spring",
                                                    "Benthivore Fall",
                                                    "Benthivore Spring",
                                                    "Planktivore Fall",
                                                    "Planktivore Spring",
                                                    "Benthos Fall",
                                                    "Benthos Spring"))
menh %>% 
  ggplot(aes(x = Time, y = Value, color = Var)) +
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  # geom_gls(aes(x = Time, y = Value,
  #              color = Var),
  #            alpha = trend.alpha, size = trend.size) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Biomass (kg tow"^-1*")")) +
  ggtitle("MA Inshore BTS") +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))

```

#### Proportion managed species in NEFSC BTS

```{r gom-survey-prop, fig.width=8, fig.asp = 0.9}

gom_prop <- 
  prop %>% 
    filter(EPU == "GOM") %>% 
  dplyr::rename(Council = council) %>% 
ggplot(aes(x = Time, y = Value, color = Council, group = Var2)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
           xmin = x.shade.min , xmax = x.shade.max ,
           ymin = -Inf, ymax = Inf) +
  
  #Add time series
  geom_line(size = 0.5) +
  geom_point_interactive(aes(tooltip = tt),size = 0.5) +
#  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var2,
                 color = Council),
             size = 0.5,
             alpha = hline.alpha,
             linetype = hline.lty)+
  
  #Facet 
  facet_wrap(Var~., ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Proportion of survey")) +
  ggtitle("GOM")+
  theme_facet()+
  theme(strip.text=element_text(hjust=0))
gom_prop <- girafe(ggobj = gom_prop)
gom_prop <- girafe_options(gom_prop, opts_zoom(max = 5) )
gom_prop
```

```{r gb-prop, fig.width = 8, fig.asp=0.9}
gb_prop <- 
  prop %>% 
    filter(EPU == "GB") %>% 
  dplyr::rename(Council = council) %>% 
ggplot(aes(x = Time, y = Value, color = Council, group = Var2)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
           xmin = x.shade.min , xmax = x.shade.max ,
           ymin = -Inf, ymax = Inf) +
  
  #Add time series
  geom_line(size = 0.5) +
  geom_point_interactive(aes(tooltip = tt),size = 0.5) +
#  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var2,
                 color = Council),
             size = 0.5,
             alpha = hline.alpha,
             linetype = hline.lty)+
  
  #Facet 
  facet_wrap(Var~., ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Proportion of survey")) +
  ggtitle("GB")+
  theme_facet()+
  theme(strip.text=element_text(hjust=0))
gb_prop <- girafe(ggobj = gb_prop)
gb_prop <- girafe_options(gb_prop, opts_zoom(max = 5) )
gb_prop
```

### Condition factor

```{r ne-cf, fig.cap = "Condition factor for NEFMC and jointly managed species."}
image.dir <- here::here("docs")

knitr::include_graphics(file.path(image.dir, "NEFMC_Fish_Condition_2019.jpg"))

```

### Larval diversity {.tabset .tabset-fade}

#### Gulf of Maine

```{r gom-larval-div}
gom_larv_div <- ecodata::ichthyo_diversity %>%
  filter(EPU == "GOM",
         str_detect(Var, "Ich Shannon")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("GOM larval diversity") +
  ylab("Shannon Diversity") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

gom_spec_rich <- ecodata::ichthyo_diversity %>%
  filter(EPU == "GOM",
         str_detect(Var, "Species Caught")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("GOM larval species richness") +
  ylab("Species richness") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

 gom_larv_div + gom_spec_rich + plot_layout(ncol = 1)
```

#### Georges Bank

```{r gb-larval-div}
gb_larv_div <- ecodata::ichthyo_diversity %>%
  filter(EPU == "GB",
         str_detect(Var, "Ich Shannon")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("GB larval diversity") +
  ylab("Shannon Diversity") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

gb_spec_rich <- ecodata::ichthyo_diversity %>%
  filter(EPU == "GB",
         str_detect(Var, "Species Caught")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("GB larval species richness") +
  ylab("Species richness") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

 gb_larv_div + gb_spec_rich + plot_layout(ncol = 1)
```



## Shelfwide Indicators

### Protected species {.tabset .tabset-fade}

#### NARW

```{r NARW-abundance, fig.width = 6, fig.asp = 0.55,fig.cap = "Estimated North Atlanic right whale abundance. Error bars represent the 95\\% credible interval."}
hline <- mean(narw[narw$Var == "right whale abundance median",]$Value)

ecodata::narw %>% 
  spread(.,Var,Value) %>% 
  ggplot() +
#Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = `right whale abundance median`), size = lwd-0.75) +
  geom_point(aes(x = Time, y = `right whale abundance median`), size = pcex-0.75) +
  geom_errorbar(aes(x = Time,
                    ymin = `right whale abundance lcl`,
                  ymax = `right whale abundance ucl`), 
                width = 0.25) +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ggtitle("NARW abundance") +
  ylab(expression("Abundance (n)")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline),
           color = "black",
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()
```

#### Harbor porpoise bycatch

```{r harbor-porpoise-bars, fig.width = 6, fig.asp = 0.55, fig.cap = "Harbor porpoise bycatch estimate (black) shown with Potential Biological Removal (red). Error bars indicate 95\\% confidence interval."}
ecodata::harborporpoise %>% 
  spread(.,Var,Value) %>% 
ggplot() +
    annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = `harbor porpoise bycatch estimate`, color = "Harbor Porpoise Bycatch"), size = lwd) +
  geom_point(aes(x = Time, y = `harbor porpoise bycatch estimate`, color = "Harbor Porpoise Bycatch"), size = pcex) +
  geom_errorbar(aes(x = Time,
                    ymin = `harbor porpoise bycatch lo95ci`,
                  ymax = `harbor porpoise bycatch up95ci`,
                  color = "Harbor Porpoise Bycatch"), 
                width = 0.25)+
  geom_line(aes(x = Time, y = `harbor porpoise bycatch pbr`, color = "PBR"), size = lwd-0.1) +
  scale_color_manual("", values = c("Harbor Porpoise Bycatch" = "black", "PBR" = "red")) +
  guides(color = guide_legend(override.aes = list(shape = c(19,NA)))) +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  ggtitle("Harbor porpoise bycatch") +
  ylab("Bycatch Estimate (n)") +
  theme_ts() +
  theme(legend.position = c(0.4, 0.85), legend.background = element_rect(
    fill = "transparent"), legend.text = element_text(size = 10))

```

#### Common tern diet composition


```{r tern-diet-diversity, fig.cap = "Shannon diversity of common tern diets observed at nesting sites in Gulf of Maine. Diversity of common tern diets has been predominantly above the long-term mean since 2006.",fig.width = 5, fig.asp = 0.55}

diet_div <- ecodata::common_tern %>% 
  filter(str_detect(Var, "Diet"),
         !str_detect(Var, "Sum")) %>% 
  mutate(Island = word(Var, 1),
         Var = word(Var, 4)) %>% 
  group_by(Island, Time) %>%
  dplyr::summarise(evenness = diversity(Value)/log(specnumber(Value)),
                   shannon = diversity(Value),
                   simpson = diversity(Value, index = "simpson")) %>% 
  gather(.,Var,Value,-Island, -Time) %>% 
  group_by(Var, Time) %>%
  dplyr::summarize(Value = mean(Value, na.rm = T),
                   sd = sd(Value, na.rm = T),
                   n = n()) %>%
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T))

# evenness <- diet_div %>% 
#   filter(Var == "evenness") %>% 
# ggplot(aes(x = Time, y = Value)) +
#       annotate("rect", fill = shade.fill, alpha = shade.alpha,
#       xmin = x.shade.min , xmax = x.shade.max,
#       ymin = -Inf, ymax = Inf) +
#   geom_line() +
#   geom_point() +
#  # geom_gls() +
#   scale_x_continuous(expand = c(0.01, 0.01),limits = c(1992,2018)) +
#   ggtitle("Evenness")+
#   ylab(expression("Evenness")) +
#   xlab("")+
#   geom_hline(aes(yintercept = hline),
#            size = hline.size,
#            alpha = hline.alpha,
#            linetype = hline.lty) +
#   theme_ts() 

shannon <- diet_div %>% 
  filter(Var == "shannon") %>% 
ggplot(aes(x = Time, y = Value)) +
      annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line() +
  geom_point() +
  #geom_gls() +
  scale_x_continuous(expand = c(0.01, 0.01),limits = c(1992,2018)) +
  ggtitle("Common tern diet diversity")+
  ylab(expression("Shannon Diversity")) +
  xlab("")+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() 

shannon 
```

```{r prey-frequencies, eval = F}


prey_freq %>% 
  dplyr::rename(Prey = Var) %>% 
ggplot(aes(x = Time, y = Freq, color = Prey)) +
      annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line() +
  geom_point() +
  guides(color = F)+
  scale_x_continuous(expand = c(0.01, 0.01),limits = c(1992,2018)) +
  facet_wrap(Prey~., scales = "free_y")+
  ggtitle("Common tern prey frequencies")+
  ylab(expression("Freq. of occurrence")) +
  xlab("")+
  geom_hline(aes(yintercept = hline,
                 color = Prey),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_facet() +
  theme(strip.text=element_text(hjust=0))


```


```{r stacked-bar-prey-freq, fig.cap = "Prey frequencies in the diets of common tern observed at seven different islands in Gulf of Maine. Prey occurring in <5% of common tern diets were excluded for clarity.", fig.height = 4, fig.width = 8}

prey_freq <- ecodata::common_tern %>% 
  filter(str_detect(Var, "Diet"),
         !str_detect(Var, "Sum")) %>% 
    mutate(Island = word(Var, 1),
         Var = word(Var, 4)) %>%
    group_by(Var, Time) %>% 
    dplyr::summarise(Value = sum(Value, na.rm = T)) %>% 
    group_by(Time) %>% 
    mutate(Freq = Value/sum(Value, na.rm = T)) %>% 
    group_by(Var) %>% 
  mutate(hline = mean(Freq, na.rm = T))

diet_freq_bar <- prey_freq %>% 
  filter(Freq > 0.05) %>% 
  dplyr::rename(Prey = Var) %>% 
  ggplot(aes(x = Time, y = Freq, fill = Prey)) +
  geom_bar_interactive(aes(tooltip = paste(Prey,round(Freq,2),Time)),stat = "identity") +
  viridis::scale_fill_viridis(discrete = TRUE) +
  ggtitle("Prey frequency") +
  ylab("Frequency of occurrence") +
  theme_ts()


diet_freq_bar <- girafe(ggobj = diet_freq_bar)
diet_freq_bar <- girafe_options(diet_freq_bar, opts_zoom(max = 5) )
diet_freq_bar
```

#### Common tern sampling sites

```{r common-tern, fig.cap = "Locations of the seven sampled common tern nesting sites in Gulf of Maine (EER = Eastern Egg Rock, JI = Jenny Island, MR = Matinicus Rock, OGI = Outer Green Island, PINWR = Pond Island National Wildlife Refuge, SINWR = Seal Island National Wildlife Refuge, STI = Stratton Island). "}
# Set lat/lon window for maps
xmin = -70.5
xmax = -68.25
ymin = 43
ymax = 44.5
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)


island_loc <- data.frame(Island = c("EER","JI","MR","OGI",
                                    "PINWR","SINWR","STI"),
                         Latitude = c(43.861,43.764,43.785,43.650,
                                      43.739,43.886,43.505),
                         Longitude = c(-69.382,-69.909,-68.854,-70.124,
                                       -69.771,-68.742,-70.312))

islands <- ggplot() +
  geom_sf(data = new_england, size = map.lwd) +
  geom_point(data = island_loc, aes(x = Longitude, y = Latitude)) +
  geom_label_repel(data = island_loc, aes(x = Longitude, y = Latitude,
                                          label = Island), nudge_y  = -0.1) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  theme_map() +
  ggtitle("Common tern study sites") +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 8))

# inset_states <- new_england %>% filter(STATE_NAME %in% c("Maine",
#                                                          "New Hampshire",
#                                                          "Massachusetts"))


# Set lat/lon window for maps
xmin2 = -72
xmax2 = -66.25
ymin2 = 42.5
ymax2 = 47.5
xlims2 <- c(xmin2, xmax2)
ylims2 <- c(ymin2, ymax2)

NE <- ggplotGrob(
ggplot()+
  geom_sf(data = new_england, size = map.lwd) +
  coord_sf(crs = crs, xlim = xlims2, ylim = ylims2) +
  annotate("rect", xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, color = "black",
           size = 0.1, fill = "transparent") +
  theme_map() +
  xlab("") +
  ylab("") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_blank())
)

full_map <- islands +
  annotation_custom(grob = NE, xmin = -69, xmax = -68.25, ymin = 42.9, ymax = 43.6)


full_map
```

#### Common tern productivity

```{r productivity, fig.width = 8,fig.height = 4, fig.cap = "Productivity of common tern at different nesting sites in Gulf of Maine, where productivity is defined as the number of fledged chicks per nest."}

ecodata::common_tern %>% 
    filter(!str_detect(Var, "Diet|Sum"))  %>% 
  mutate(Island = word(Var, 1),
         Var = word(Var, 3),
         Island = plyr::mapvalues(Island, from = c("EER","JI","MR","OGI","PINWR","SINWR","STI"),
                                  to = c("Eastern Egg Rock", "Jenny Island", "Matinicus Rock", "Outer Green Island", "Pond Island", "Seal Island","Stratton Island"))) %>%
  group_by(Island) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
ggplot(aes(x = Time, y = Value, group = Island)) +
      annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line() +
  geom_point() +
  guides(color = F)+
  scale_x_continuous(expand = c(0.01, 0.01)) +
  facet_wrap(Island~., scales = "free_y", nrow = 2)+
  ggtitle("Productivity")+
  ylab(expression("Fledged chicks per nest")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline,
                 group = Island),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_facet() +
  theme(strip.text=element_text(hjust=0))




```

```{r aggregate-prod, fig.cap = "Mean common tern productivity at nesting sites in Gulf of Maine. Error bars show +/- 1 SE of the mean.",fig.width = 5, fig.asp = 0.55 }
aggregate_prod <- ecodata::common_tern %>% 
    filter(!str_detect(Var, "Diet|Sum"))  %>% 
  mutate(Island = word(Var, 1),
         Var = word(Var, 3),
         Island = plyr::mapvalues(Island, from = c("EER","JI","MR","OGI","PINWR","SINWR","STI"),
                                  to = c("Eastern Egg Rock", "Jenny Island", "Matinicus Rock", "Outer Green Island", "Pond Island", "Seal Island","Stratton Island"))) %>%
  group_by(Time) %>% 
  dplyr::summarise(Mean = mean(Value, na.rm = T),
                   SE = sd(Value, na.rm = T)/sqrt(n()),
                   SD = sd(Value, na.rm = T),
                   n = n()) %>% 
  mutate(Mean = ifelse(is.na(SE),NA,Mean),
         se.low = Mean - SE,
         se.high = Mean + SE,
         hline = mean(Mean, na.rm = T))

aggregate_prod %>% 
  ggplot() +
#Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = Mean), size = lwd-0.75) +
  geom_point(aes(x = Time, y = Mean), size = pcex-0.75) +
  geom_gls(aes(x = Time, y = Mean)) +
  geom_errorbar(aes(x = Time,
                    ymin = se.low,
                  ymax = se.high), 
                width = 0.25) +
  scale_x_continuous(expand = c(0.01, 0.01),limits = c(1991,2018)) +
  guides(color = FALSE) +
  ggtitle("Common tern productivity") +
  ylab(expression("Fledged chicks per nest")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline),
           color = "black",
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()


```


### Larval diversity


```{r all-larval-div}
all_larv_div <- ecodata::ichthyo_diversity %>%
  filter(EPU == "All",
         str_detect(Var, "Ich Shannon")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("NES larval diversity") +
  ylab("Shannon Diversity") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

all_spec_rich <- ecodata::ichthyo_diversity %>%
  filter(EPU == "All",
         str_detect(Var, "Species Caught")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("NES larval species richness") +
  ylab("Species richness") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

 all_larv_div + all_spec_rich + plot_layout(ncol = 1)
```

### Aggregate species distribution

```{r spec-dist,fig.width = 5, fig.asp = 1.25, fig.cap = "Aggregate species distribution metrics for species in the Northeast Large Marine Ecosystem."}

spec_dist <- ecodata::species_dist %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))

asd <- spec_dist %>% 
  filter(Var == "along-shelf distance") %>% 
  ggplot(aes(x = Time, y = Value,
               group = Var)) + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  ggtitle("Along-shelf distance")+
  ylab(expression("Distance (km)")) +
  xlab("")+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() 

depth <- spec_dist %>% 
  filter(Var == "depth") %>% 
  ggplot(aes(x = Time, y = Value,
               group = Var)) + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  ggtitle("Depth")+
  ylab(expression("Depth (m)")) +
  xlab("")+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() 

dtc <- spec_dist %>% 
  filter(Var == "distance to coast") %>% 
  ggplot(aes(x = Time, y = Value,
               group = Var)) + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  ggtitle("Distance to coast")+
  ylab(expression("Distance (km)")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() 

asd + depth + dtc + plot_layout(ncol = 1) 

```

